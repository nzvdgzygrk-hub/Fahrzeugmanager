<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Fahrzeugmanager</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      max-width: 1100px;
    }
    h1, h2, h3 {
      color: #333;
    }
    .box {
      border: 1px solid #ccc;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 6px;
      background: #f9f9f9;
    }
    label {
      display: block;
      margin-top: 8px;
      font-weight: bold;
    }
    input[type="text"],
    input[type="number"],
    input[type="date"],
    select,
    textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 6px;
      margin-top: 2px;
    }
    button {
      margin-top: 10px;
      padding: 8px 14px;
      cursor: pointer;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 0.9rem;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: left;
    }
    th {
      background: #eee;
    }
    .flex-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .flex-col {
      flex: 1 1 250px;
    }
    .danger {
      background: #fbe9e9;
      border-color: #f5b5b5;
    }
    .small-text {
      font-size: 0.8rem;
      color: #666;
    }
    .summary {
      margin-top: 10px;
      font-size: 0.9rem;
      white-space: pre-line;
    }
    .highlight {
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Fahrzeugmanager</h1>
  <p class="small-text">
    Alles wird nur lokal im Browser gespeichert. Kein Internet, kein Server.<br>
    Passwort zum Löschen: <span class="highlight">Fatih</span>
  </p>

  <!-- Dashboard -->
  <div class="box">
    <h2>Übersicht (Dashboard)</h2>
    <p class="small-text">
      TÜV, letzter Ölwechsel, nächster Ölwechsel und letzter Verbrauch im Überblick.
    </p>
    <ul>
      <li><strong>TÜV:</strong> <span id="dashTuevInfo">keine Daten</span></li>
      <li><strong>Letzter Ölwechsel:</strong> <span id="dashOilInfo">keine Einträge gefunden</span></li>
      <li><strong>Nächster Ölwechsel:</strong> <span id="dashNextOilInfo">keine Daten</span></li>
      <li><strong>Letzter Verbrauch:</strong> <span id="dashFuelInfo">keine Tankdaten</span></li>
    </ul>
  </div>

  <!-- Fahrzeugdaten -->
  <div class="box">
    <h2>Fahrzeugdaten</h2>
    <p class="small-text">
      Hier kannst du Marke, Modell, Schlüsselnummern und TÜV speichern.
    </p>
    <div class="flex-row">
      <div class="flex-col">
        <label for="markeInput">Marke</label>
        <input type="text" id="markeInput" value="Mazda">

        <label for="modellInput">Modell</label>
        <input type="text" id="modellInput" value="2 DY">

        <label for="kontaktInput">Kontakt / Handy</label>
        <input type="text" id="kontaktInput" placeholder="z. B. 0176 ...">
      </div>
      <div class="flex-col">
        <label for="schluessel21Input">Schlüsselnummer zu 2.1</label>
        <input type="text" id="schluessel21Input" value="7118">

        <label for="schluessel22Input">Schlüsselnummer zu 2.2</label>
        <input type="text" id="schluessel22Input" value="273">

        <label for="kennzeichenInput">Kennzeichen / Notiz</label>
        <input type="text" id="kennzeichenInput" placeholder="z. B. V-AB 123">
      </div>
      <div class="flex-col">
        <label for="tuevBisInput">TÜV gültig bis</label>
        <input type="date" id="tuevBisInput">
        <p class="small-text">
          Wird im Dashboard angezeigt, wie lange der TÜV noch gilt.
        </p>
      </div>
    </div>
    <button id="saveVehicleButton">Fahrzeugdaten speichern</button>
    <button id="deleteVehicleButton">Fahrzeugdaten löschen (Passwort)</button>
    <p id="vehicleSavedMessage" class="small-text"></p>
  </div>

  <!-- Wartung / Reparaturen -->
  <div class="box">
    <h2>Wartung &amp; Reparaturen</h2>
    <p class="small-text">
      Trage hier z. B. Zahnriemenwechsel, Ölwechsel, TÜV, Bremsen usw. ein.
      Das Datum wird automatisch mit dem aktuellen Tag übernommen.<br>
      <strong>Hinweis:</strong> Für den letzten Ölwechsel im Dashboard wird der letzte Eintrag genommen,
      bei dem in der Beschreibung das Wort „Öl“ oder „Ölwechsel“ vorkommt.<br>
      Wenn du im Text „TÜV“ eingibst, wirst du gefragt, ob das TÜV-Datum oben aktualisiert werden soll.
    </p>

    <div class="flex-row">
      <div class="flex-col">
        <label for="wartungKmInput">Kilometerstand</label>
        <input type="number" id="wartungKmInput" min="0" step="1" placeholder="z. B. 145000">
      </div>
      <div class="flex-col">
        <label for="wartungArtInput">Reparatur / Wartung</label>
        <input type="text" id="wartungArtInput" placeholder="z. B. Ölwechsel, TÜV, Zahnriemenwechsel">
      </div>
    </div>

    <div class="flex-row">
      <div class="flex-col">
        <label for="wartungKostenInput">Kosten (€)</label>
        <input type="number" id="wartungKostenInput" min="0" step="0.01" placeholder="optional">
      </div>
    </div>

    <div class="flex-row">
      <div class="flex-col">
        <label for="oelIntervallInput">Ölwechsel-Intervall (km)</label>
        <input type="number" id="oelIntervallInput" min="1000" step="500" placeholder="z. B. 15000">
        <button id="saveOelIntervallButton">Intervall speichern</button>
        <p id="oelIntervallMessage" class="small-text"></p>
      </div>
    </div>

    <button id="addWartungButton">Wartung hinzufügen (heutiges Datum)</button>
    <button id="deleteLastWartungButton">Letzten Wartungs-Eintrag löschen (Passwort)</button>
    <button id="deleteWartungButton">Alle Wartungs-Einträge löschen (Passwort)</button>
    <button id="copyWartungButton">Wartungsdaten kopieren</button>

    <table>
      <thead>
        <tr>
          <th>Datum</th>
          <th>Kilometerstand</th>
          <th>Reparatur / Wartung</th>
          <th>Kosten (€)</th>
        </tr>
      </thead>
      <tbody id="wartungTableBody"></tbody>
    </table>
    <div id="wartungSummary" class="summary"></div>
  </div>

  <!-- Tanken / Verbrauch -->
  <div class="box">
    <h2>Tanken &amp; Verbrauch</h2>
    <p class="small-text">
      Trage Tankvorgänge ein. Verbrauch und Kosten werden automatisch berechnet.<br>
      Verbrauch: Liter / gefahrene Kilometer × 100.<br>
      Standard: Benzin. Letzter Kraftstoff &amp; Preis bleiben gespeichert. Datum wird automatisch auf heute gesetzt.
    </p>

    <div class="flex-row">
      <div class="flex-col">
        <label for="tankenDatumInput">Datum</label>
        <input type="date" id="tankenDatumInput">

        <label for="tankenKmInput">gefahrene Kilometer</label>
        <input type="number" id="tankenKmInput" min="0" step="1" placeholder="z. B. 450">
      </div>
      <div class="flex-col">
        <label for="tankenKraftstoffInput">Kraftstoffart</label>
        <select id="tankenKraftstoffInput">
          <option value="">bitte wählen</option>
          <option value="Benzin">Benzin</option>
          <option value="Diesel">Diesel</option>
          <option value="LPG">LPG / Gas</option>
          <option value="Hybrid/sonstiges">Hybrid / Sonstiges</option>
        </select>

        <label for="tankenLiterInput">getankte Liter</label>
        <input type="number" id="tankenLiterInput" min="0" step="0.01" placeholder="z. B. 32.5">
      </div>
      <div class="flex-col">
        <label for="tankenPreisInput">Preis pro Liter (€)</label>
        <input type="number" id="tankenPreisInput" min="0" step="0.001" placeholder="z. B. 1.849">
      </div>
    </div>

    <button id="addTankenButton">Tanken-Eintrag hinzufügen</button>
    <button id="deleteLastTankenButton">Letzten Tank-Eintrag löschen (Passwort)</button>
    <button id="deleteTankenButton">Alle Tank-Einträge löschen (Passwort)</button>
    <button id="copyTankenButton">Tankdaten kopieren</button>

    <table>
      <thead>
        <tr>
          <th>Datum</th>
          <th>Kraftstoff</th>
          <th>km</th>
          <th>Liter</th>
          <th>Preis/Liter (€)</th>
          <th>Gesamtkosten (€)</th>
          <th>Verbrauch (L/100km)</th>
        </tr>
      </thead>
      <tbody id="tankenTableBody"></tbody>
    </table>

    <div id="tankenSummary" class="summary"></div>
  </div>

  <!-- Inspektions-Notizen -->
  <div class="box">
    <h2>Inspektions-Notizen</h2>
    <p class="small-text">
      Hier kannst du deinen eigenen Plan notieren
      (z. B. „Ölwechsel alle 15.000 km“, „TÜV 06/2026“, „Zahnriemen alle 90.000 km“).
    </p>
    <label for="inspektionNotizen">Eigener Inspektionsplan / Notizen</label>
    <textarea id="inspektionNotizen" rows="5"></textarea>
    <button id="saveInspektionButton">Inspektions-Notizen speichern</button>
    <button id="copyInspektionButton">Inspektions-Notizen kopieren</button>
    <button id="deleteInspektionButton">Inspektions-Notizen löschen (Passwort)</button>
    <p id="inspektionSavedMessage" class="small-text"></p>
  </div>

  <!-- Alle Daten löschen -->
  <div class="box danger">
    <h2>ALLE Daten löschen</h2>
    <p class="small-text">
      Löscht Fahrzeugdaten, Wartungs- und Tankliste sowie Inspektions-Notizen.<br>
      Nur mit Passwort und zusätzlicher Sicherheitsfrage.
    </p>
    <button id="deleteAllButton">ALLE Daten löschen (Passwort)</button>
    <p id="deleteMessage" class="small-text"></p>
  </div>

  <script>
    const PASSWORD = "Fatih";
    const VEHICLE_KEY = "fahrzeug_daten_v1";
    const WARTUNG_KEY = "fahrzeug_wartung_v1";
    const TANKEN_KEY = "fahrzeug_tanken_v1";
    const TANK_DEFAULT_KEY = "fahrzeug_tanken_defaults_v1";
    const INSPEKTION_KEY = "fahrzeug_inspektion_v1";
    const OELINTERVALL_KEY = "fahrzeug_oelintervall_v1";

    function askPasswordThen(callback) {
      const eingabe = prompt("Bitte Passwort zum Löschen eingeben:");
      if (eingabe === null) return;
      if (eingabe !== PASSWORD) {
        alert("Falsches Passwort.");
        return;
      }
      const sicher = confirm("Bist du sicher, dass du löschen möchtest?");
      if (!sicher) return;
      callback();
    }

    // ---------- Fahrzeug ----------
    function loadVehicleData() {
      const raw = localStorage.getItem(VEHICLE_KEY);
      let data;
      if (raw) {
        try { data = JSON.parse(raw); } catch { data = null; }
      }
      if (!data) {
        data = {
          marke: "Mazda",
          modell: "2 DY",
          kontakt: "",
          schluessel21: "7118",
          schluessel22: "273",
          kennzeichen: "",
          tuevBis: ""
        };
      } else if (!("tuevBis" in data)) {
        data.tuevBis = "";
      }

      markeInput.value = data.marke || "";
      modellInput.value = data.modell || "";
      kontaktInput.value = data.kontakt || "";
      schluessel21Input.value = data.schluessel21 || "";
      schluessel22Input.value = data.schluessel22 || "";
      kennzeichenInput.value = data.kennzeichen || "";
      tuevBisInput.value = data.tuevBis || "";
    }

    function saveVehicleData() {
      const data = {
        marke: markeInput.value.trim(),
        modell: modellInput.value.trim(),
        kontakt: kontaktInput.value.trim(),
        schluessel21: schluessel21Input.value.trim(),
        schluessel22: schluessel22Input.value.trim(),
        kennzeichen: kennzeichenInput.value.trim(),
        tuevBis: tuevBisInput.value
      };
      localStorage.setItem(VEHICLE_KEY, JSON.stringify(data));
      vehicleSavedMessage.textContent = "Fahrzeugdaten gespeichert.";
      setTimeout(() => vehicleSavedMessage.textContent = "", 3000);
      renderDashboard();
    }

    function autoUpdateTuevFromInput() {
      const raw = localStorage.getItem(VEHICLE_KEY);
      let data = null;
      if (raw) { try { data = JSON.parse(raw); } catch { data = null; } }
      if (!data) {
        data = {
          marke: markeInput.value.trim() || "Mazda",
          modell: modellInput.value.trim() || "2 DY",
          kontakt: kontaktInput.value.trim() || "",
          schluessel21: schluessel21Input.value.trim() || "7118",
          schluessel22: schluessel22Input.value.trim() || "273",
          kennzeichen: kennzeichenInput.value.trim() || "",
          tuevBis: tuevBisInput.value
        };
      } else {
        data.tuevBis = tuevBisInput.value;
      }
      localStorage.setItem(VEHICLE_KEY, JSON.stringify(data));
      renderDashboard();
    }

    function deleteVehicleData() {
      askPasswordThen(() => {
        localStorage.removeItem(VEHICLE_KEY);
        loadVehicleData();
        renderDashboard();
        vehicleSavedMessage.textContent = "Fahrzeugdaten gelöscht (Standard Mazda 2 DY wieder eingesetzt).";
        setTimeout(() => vehicleSavedMessage.textContent = "", 4000);
      });
    }

    // ---------- Ölintervall ----------
    function loadOelIntervall() {
      const raw = localStorage.getItem(OELINTERVALL_KEY);
      let val = 15000;
      if (raw) {
        const num = Number(raw);
        if (!isNaN(num) && num > 0) val = num;
      }
      oelIntervallInput.value = val;
    }

    function saveOelIntervall() {
      const num = Number(oelIntervallInput.value);
      if (isNaN(num) || num <= 0) {
        oelIntervallMessage.textContent = "Bitte eine gültige Kilometerzahl > 0 eingeben.";
        setTimeout(() => oelIntervallMessage.textContent = "", 3000);
        return;
      }
      localStorage.setItem(OELINTERVALL_KEY, String(num));
      oelIntervallMessage.textContent = "Intervall gespeichert.";
      setTimeout(() => oelIntervallMessage.textContent = "", 3000);
      renderDashboard();
    }

    function getOelIntervallValue() {
      const raw = localStorage.getItem(OELINTERVALL_KEY);
      let val = 15000;
      if (raw) {
        const num = Number(raw);
        if (!isNaN(num) && num > 0) val = num;
      }
      return val;
    }

    // ---------- Wartung ----------
    function getWartungList() {
      const raw = localStorage.getItem(WARTUNG_KEY);
      if (!raw) return [];
      try { return JSON.parse(raw); } catch { return []; }
    }

    function saveWartungList(list) {
      localStorage.setItem(WARTUNG_KEY, JSON.stringify(list));
    }

    // Deine 11 Einträge mit Kosten – nur wenn noch nichts existiert
    function seedInitialWartung() {
      if (localStorage.getItem(WARTUNG_KEY)) return;
      const d = new Date(2025, 10, 25); // 25.11.2025
      const ms = d.getTime();
      const dt = d.toLocaleDateString("de-DE");
      const km = 99722;

      const list = [
        { datum: dt, dateMs: ms, km: 99272, art: "TÜV", kosten: 170 },
        { datum: dt, dateMs: ms, km, art: "Zahnriemensatz", kosten: 400 },
        { datum: dt, dateMs: ms, km, art: "Reifen 2x vorne", kosten: 100 },
        { datum: dt, dateMs: ms, km, art: "Keilrippen 2x", kosten: 70 },
        { datum: dt, dateMs: ms, km, art: "Frostschutz", kosten: 5 },
        { datum: dt, dateMs: ms, km, art: "Luftfilter", kosten: 10 },
        { datum: dt, dateMs: ms, km, art: "Klimafilter", kosten: 20 },
        { datum: dt, dateMs: ms, km, art: "Ölwechsel", kosten: 50 },
        { datum: dt, dateMs: ms, km, art: "Kühlwasserthermostat", kosten: 50 },
        { datum: dt, dateMs: ms, km, art: "Standlicht", kosten: 10 },
        { datum: dt, dateMs: ms, km, art: "Abblendlicht", kosten: 15 }
      ];
      saveWartungList(list);
    }

    function renderWartungTable() {
      const tbody = wartungTableBody;
      tbody.innerHTML = "";
      const list = getWartungList();

      list.slice().sort((a,b)=>(a.dateMs||0)-(b.dateMs||0)).forEach(e => {
        const tr = document.createElement("tr");
        const tdD = document.createElement("td");
        const tdKm = document.createElement("td");
        const tdA = document.createElement("td");
        const tdK = document.createElement("td");

        tdD.textContent = e.datum || "";
        tdKm.textContent = e.km != null ? e.km + " km" : "";
        tdA.textContent = e.art || "";
        tdK.textContent = (e.kosten != null && !isNaN(e.kosten)) ? e.kosten.toFixed(2) + " €" : "";

        tr.appendChild(tdD);
        tr.appendChild(tdKm);
        tr.appendChild(tdA);
        tr.appendChild(tdK);
        tbody.appendChild(tr);
      });

      renderWartungSummary();
    }

    function renderWartungSummary() {
      const list = getWartungList();
      if (!list.length) {
        wartungSummary.textContent = "Noch keine Wartungskosten erfasst.";
        return;
      }

      let total = 0;
      const perMonth = {};

      list.forEach(e => {
        if (e.kosten != null && !isNaN(e.kosten) && e.kosten > 0) {
          total += e.kosten;
          let key = "ohne Datum";
          if (e.dateMs) {
            const d = new Date(e.dateMs);
            if (!isNaN(d.getTime())) {
              const m = String(d.getMonth() + 1).padStart(2, "0");
              const y = d.getFullYear();
              key = m + "/" + y;
            }
          }
          perMonth[key] = (perMonth[key] || 0) + e.kosten;
        }
      });

      if (!total) {
        wartungSummary.textContent = "Noch keine Wartungskosten erfasst.";
        return;
      }

      let text = "Gesamt Wartungskosten: " + total.toFixed(2) + " €\n";
      Object.keys(perMonth)
        .sort((a,b)=>{
          const [ma,ya]=a.split("/"); const [mb,yb]=b.split("/");
          return new Date(+ya,+ma-1,1) - new Date(+yb,+mb-1,1);
        })
        .forEach(k => { text += k + ": " + perMonth[k].toFixed(2) + " €\n"; });

      wartungSummary.textContent = text.trim();
    }

    function maybeAskUpdateTuevFromWartung(text) {
      if (!text) return;
      const t = text.toLowerCase();
      if (!(t.includes("tüv") || t.includes("tuev") || t.includes("tuv"))) return;

      const ok = confirm("In diesem Wartungseintrag steht 'TÜV'.\nTÜV-Datum oben aktualisieren?");
      if (!ok) return;

      const current = tuevBisInput.value || "";
      const neu = prompt("Neues TÜV-Datum (JJJJ-MM-TT):", current);
      if (!neu) return;
      if (!/^\d{4}-\d{2}-\d{2}$/.test(neu)) {
        alert("Ungültiges Format. Beispiel: 2026-06-30");
        return;
      }
      tuevBisInput.value = neu;
      autoUpdateTuevFromInput();
    }

    function addWartungEntry() {
      const km = wartungKmInput.value === "" ? null : Number(wartungKmInput.value);
      const art = wartungArtInput.value.trim();
      const kostenStr = wartungKostenInput.value;

      if (km == null || isNaN(km)) {
        alert("Bitte einen gültigen Kilometerstand eingeben.");
        return;
      }
      if (!art) {
        alert("Bitte eine Beschreibung der Wartung/Reparatur eingeben.");
        return;
      }

      let kosten = null;
      if (kostenStr !== "") {
        kosten = Number(kostenStr);
        if (isNaN(kosten) || kosten < 0) {
          alert("Bitte gültige Kosten eingeben oder Feld leer lassen.");
          return;
        }
      }

      const now = new Date();
      const list = getWartungList();
      list.push({
        datum: now.toLocaleDateString("de-DE"),
        dateMs: now.getTime(),
        km, art, kosten
      });
      saveWartungList(list);

      wartungKmInput.value = "";
      wartungArtInput.value = "";
      wartungKostenInput.value = "";

      renderWartungTable();
      renderDashboard();
      maybeAskUpdateTuevFromWartung(art);
    }

    function deleteWartungData() {
      askPasswordThen(() => {
        localStorage.removeItem(WARTUNG_KEY);
        renderWartungTable();
        renderDashboard();
      });
    }

    function deleteLastWartung() {
      askPasswordThen(() => {
        const list = getWartungList();
        if (!list.length) { alert("Keine Wartungseinträge vorhanden."); return; }
        list.pop();
        saveWartungList(list);
        renderWartungTable();
        renderDashboard();
      });
    }

    // ---------- Tanken ----------
    function getTankenList() {
      const raw = localStorage.getItem(TANKEN_KEY);
      if (!raw) return [];
      try { return JSON.parse(raw); } catch { return []; }
    }
    function saveTankenList(list) {
      localStorage.setItem(TANKEN_KEY, JSON.stringify(list));
    }

    function loadTankDefaults() {
      const raw = localStorage.getItem(TANK_DEFAULT_KEY);
      let def = { kraftstoff: "Benzin", preis: "" };
      if (raw) {
        try {
          const p = JSON.parse(raw);
          if (p && typeof p === "object") {
            if (p.kraftstoff) def.kraftstoff = p.kraftstoff;
            if (p.preis !== undefined) def.preis = p.preis;
          }
        } catch {}
      }
      tankenKraftstoffInput.value = def.kraftstoff || "Benzin";
      if (def.preis !== "" && def.preis != null && !isNaN(def.preis)) {
        tankenPreisInput.value = def.preis;
      }
    }

    function setTodayForTankDate() {
      if (!tankenDatumInput.value) {
        const d = new Date();
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const dd = String(d.getDate()).padStart(2, "0");
        tankenDatumInput.value = `${yyyy}-${mm}-${dd}`;
      }
    }

    function renderTankenTable() {
      const tbody = tankenTableBody;
      tbody.innerHTML = "";
      const list = getTankenList();

      list.slice().sort((a,b)=>(a.dateMs||0)-(b.dateMs||0)).forEach(e => {
        const tr = document.createElement("tr");
        const tdD = document.createElement("td");
        const tdKf = document.createElement("td");
        const tdKm = document.createElement("td");
        const tdL = document.createElement("td");
        const tdP = document.createElement("td");
        const tdK = document.createElement("td");
        const tdV = document.createElement("td");

        tdD.textContent = e.datum || "";
        tdKf.textContent = e.kraftstoff || "";
        tdKm.textContent = e.km != null ? e.km + " km" : "";
        tdL.textContent = e.liter != null ? e.liter.toFixed(2) + " L" : "";
        tdP.textContent = e.preis != null ? e.preis.toFixed(3) + " €/L" : "";
        tdK.textContent = e.kosten != null ? e.kosten.toFixed(2) + " €" : "";
        tdV.textContent = e.verbrauch != null ? e.verbrauch.toFixed(2) + " L/100km" : "";

        tr.appendChild(tdD);
        tr.appendChild(tdKf);
        tr.appendChild(tdKm);
        tr.appendChild(tdL);
        tr.appendChild(tdP);
        tr.appendChild(tdK);
        tr.appendChild(tdV);   // WICHTIG: Verbrauch-Spalte anhängen
        tbody.appendChild(tr);
      });

      renderTankenSummary();
    }

    function renderTankenSummary() {
      const list = getTankenList();
      if (!list.length) {
        tankenSummary.textContent = "Noch keine Tankdaten erfasst.";
        renderDashboard();
        return;
      }

      let sumV = 0, countV = 0, sumK = 0;
      list.forEach(e => {
        if (e.verbrauch != null && !isNaN(e.verbrauch) && e.km > 0) {
          sumV += e.verbrauch; countV++;
        }
        if (e.kosten != null && !isNaN(e.kosten)) sumK += e.kosten;
      });

      const avg = countV ? sumV / countV : null;
      const last = list.slice().sort((a,b)=>(a.dateMs||0)-(b.dateMs||0)).pop();

      let text = `Anzahl Tankvorgänge: ${list.length}. Gesamt-Kosten: ${sumK.toFixed(2)} €.`;
      if (avg != null) text += ` Durchschnittsverbrauch: ${avg.toFixed(2)} L/100km.`;
      if (last && last.verbrauch != null && !isNaN(last.verbrauch)) {
        text += ` Letzter Verbrauch: ${last.verbrauch.toFixed(2)} L/100km.`;
      }
      tankenSummary.textContent = text;
      renderDashboard();
    }

    function addTankenEntry() {
      setTodayForTankDate(); // Datum sicher auf heute setzen, falls leer

      const km = tankenKmInput.value === "" ? null : Number(tankenKmInput.value);
      const kraftstoff = tankenKraftstoffInput.value;
      const liter = tankenLiterInput.value === "" ? null : Number(tankenLiterInput.value);
      const preis = tankenPreisInput.value === "" ? null : Number(tankenPreisInput.value);

      if (km == null || isNaN(km) || km <= 0) {
        alert("Bitte gültige gefahrene Kilometer eingeben (> 0).");
        return;
      }
      if (liter == null || isNaN(liter) || liter <= 0) {
        alert("Bitte gültige Literzahl eingeben (> 0).");
        return;
      }
      if (preis == null || isNaN(preis) || preis <= 0) {
        alert("Bitte gültigen Preis pro Liter eingeben (> 0).");
        return;
      }
      if (!kraftstoff) {
        alert("Bitte eine Kraftstoffart auswählen.");
        return;
      }

      let dateObj;
      if (tankenDatumInput.value) {
        const [y,m,d] = tankenDatumInput.value.split("-");
        dateObj = new Date(Number(y), Number(m)-1, Number(d));
      } else {
        dateObj = new Date();
      }

      const kosten = liter * preis;
      const verbrauch = (liter / km) * 100;
      const list = getTankenList();
      list.push({
        datum: dateObj.toLocaleDateString("de-DE"),
        dateMs: dateObj.getTime(),
        km, kraftstoff, liter, preis, kosten, verbrauch
      });
      saveTankenList(list);

      tankenKmInput.value = "";
      tankenLiterInput.value = "";
      // Datum für den nächsten Eintrag wieder auf heute setzen
      setTodayForTankDate();

      const defaults = { kraftstoff, preis };
      localStorage.setItem(TANK_DEFAULT_KEY, JSON.stringify(defaults));

      renderTankenTable();
    }

    function deleteTankenData() {
      askPasswordThen(() => {
        localStorage.removeItem(TANKEN_KEY);
        renderTankenTable();
        renderDashboard();
      });
    }

    function deleteLastTanken() {
      askPasswordThen(() => {
        const list = getTankenList();
        if (!list.length) { alert("Keine Tank-Einträge vorhanden."); return; }
        list.pop();
        saveTankenList(list);
        renderTankenTable();
        renderDashboard();
      });
    }

    // ---------- Kopieren ----------
    function copyTextToClipboard(text) {
      if (!text) { alert("Nichts zum Kopieren vorhanden."); return; }
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text)
          .then(() => alert("Text in Zwischenablage kopiert."))
          .catch(() => fallbackCopy(text));
      } else {
        fallbackCopy(text);
      }
    }
    function fallbackCopy(text) {
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      try { document.execCommand("copy"); } catch(e) {}
      document.body.removeChild(ta);
      alert("Text in Zwischenablage kopiert.");
    }

    function copyInspektion() {
      const t = inspektionNotizen.value.trim();
      if (!t) { alert("Keine Inspektions-Notizen vorhanden."); return; }
      copyTextToClipboard(t);
    }

    function copyTanken() {
      const list = getTankenList();
      if (!list.length) { alert("Keine Tank-Einträge vorhanden."); return; }
      const lines = [];
      lines.push("Datum;Kraftstoff;km;Liter;Preis/Liter;Gesamtkosten;Verbrauch L/100km");
      list.slice().sort((a,b)=>(a.dateMs||0)-(b.dateMs||0)).forEach(e=>{
        lines.push([
          e.datum || "",
          e.kraftstoff || "",
          e.km != null ? e.km + " km" : "",
          e.liter != null ? e.liter.toFixed(2) + " L" : "",
          e.preis != null ? e.preis.toFixed(3) + " €/L" : "",
          e.kosten != null ? e.kosten.toFixed(2) + " €" : "",
          e.verbrauch != null ? e.verbrauch.toFixed(2) + " L/100km" : ""
        ].join(";"));
      });
      const sum = tankenSummary.textContent || "";
      if (sum) {
        lines.push("", "Zusammenfassung:", sum);
      }
      copyTextToClipboard(lines.join("\n"));
    }

    function copyWartung() {
      const list = getWartungList();
      if (!list.length) { alert("Keine Wartungsdaten vorhanden."); return; }
      const lines = [];
      lines.push("Datum;Kilometer;Text;Kosten (€)");
      list.slice().sort((a,b)=>(a.dateMs||0)-(b.dateMs||0)).forEach(e=>{
        lines.push([
          e.datum || "",
          e.km != null ? e.km + " km" : "",
          e.art || "",
          (e.kosten != null && !isNaN(e.kosten)) ? e.kosten.toFixed(2) + " €" : ""
        ].join(";"));
      });
      copyTextToClipboard(lines.join("\n"));
    }

    // ---------- Inspektionsnotizen ----------
    function loadInspektion() {
      const raw = localStorage.getItem(INSPEKTION_KEY);
      inspektionNotizen.value = raw || "";
    }
    function saveInspektion() {
      localStorage.setItem(INSPEKTION_KEY, inspektionNotizen.value);
      inspektionSavedMessage.textContent = "Inspektions-Notizen gespeichert.";
      setTimeout(()=>inspektionSavedMessage.textContent="",3000);
    }
    function deleteInspektion() {
      askPasswordThen(()=>{
        localStorage.removeItem(INSPEKTION_KEY);
        loadInspektion();
      });
    }

    // ---------- Dashboard ----------
    function renderDashboard() {
      // TÜV
      let tuevText = "keine Daten";
      const rawV = localStorage.getItem(VEHICLE_KEY);
      if (rawV) {
        try {
          const v = JSON.parse(rawV);
          if (v.tuevBis) {
            const [y,m,d] = v.tuevBis.split("-");
            const tDate = new Date(Number(y),Number(m)-1,Number(d));
            const heute = new Date();
            tDate.setHours(0,0,0,0);
            heute.setHours(0,0,0,0);
            const diffTage = Math.round((tDate-heute)/(1000*60*60*24));
            const dt = tDate.toLocaleDateString("de-DE");
            if (diffTage>0) tuevText = `bis ${dt} (noch ca. ${diffTage} Tage)`;
            else if (diffTage===0) tuevText = `bis ${dt} (läuft HEUTE ab!)`;
            else tuevText = `abgelaufen am ${dt} (seit ${Math.abs(diffTage)} Tagen)`;
          }
        } catch {}
      }
      dashTuevInfo.textContent = tuevText;

      // Ölwechsel
      const wart = getWartungList();
      const oil = wart.filter(e=>{
        if (!e.art) return false;
        const t = e.art.toLowerCase();
        return t.includes("öl") || t.includes("oel");
      });
      if (!oil.length) {
        dashOilInfo.textContent = "keine Ölwechsel-Einträge gefunden.";
        dashNextOilInfo.textContent = "kein letzter Ölwechsel vorhanden.";
      } else {
        const last = oil.slice().sort((a,b)=>(a.dateMs||0)-(b.dateMs||0)).pop();
        let txt = "am " + last.datum;
        if (last.km != null) txt += " bei ca. " + last.km + " km";
        dashOilInfo.textContent = txt;

        const intervall = getOelIntervallValue();
        if (last.km != null && !isNaN(last.km)) {
          const nextKm = last.km + intervall;
          dashNextOilInfo.textContent =
            `bei ca. ${nextKm} km (Intervall: ${intervall} km, letzter Ölwechsel bei ${last.km} km)`;
        } else {
          dashNextOilInfo.textContent =
            `Intervall: ${intervall} km – kein Kilometerstand beim letzten Ölwechsel gespeichert.`;
        }
      }

      // Verbrauch
      const tank = getTankenList();
      if (!tank.length) {
        dashFuelInfo.textContent = "keine Tankdaten vorhanden.";
      } else {
        const last = tank.slice().sort((a,b)=>(a.dateMs||0)-(b.dateMs||0)).pop();
        if (last.verbrauch != null && !isNaN(last.verbrauch)) {
          dashFuelInfo.textContent =
            `${last.verbrauch.toFixed(2)} L/100km (${last.datum}, ${last.kraftstoff || "Kraftstoff unbekannt"})`;
        } else {
          dashFuelInfo.textContent = "kein Verbrauch berechnet.";
        }
      }
    }

    // ---------- Alle löschen ----------
    function deleteAllData() {
      askPasswordThen(()=>{
        localStorage.removeItem(VEHICLE_KEY);
        localStorage.removeItem(WARTUNG_KEY);
        localStorage.removeItem(TANKEN_KEY);
        localStorage.removeItem(INSPEKTION_KEY);
        localStorage.removeItem(OELINTERVALL_KEY);
        localStorage.removeItem(TANK_DEFAULT_KEY);

        init(); // alles neu laden + Seed
        deleteMessage.textContent = "Alle Daten wurden gelöscht.";
        setTimeout(()=>deleteMessage.textContent="",4000);
      });
    }

    // ---------- Init ----------
    function init() {
      // Events
      saveVehicleButton.onclick = saveVehicleData;
      deleteVehicleButton.onclick = deleteVehicleData;
      tuevBisInput.onchange = autoUpdateTuevFromInput;

      saveOelIntervallButton.onclick = saveOelIntervall;

      addWartungButton.onclick = addWartungEntry;
      deleteWartungButton.onclick = deleteWartungData;
      deleteLastWartungButton.onclick = deleteLastWartung;
      copyWartungButton.onclick = copyWartung;

      addTankenButton.onclick = addTankenEntry;
      deleteTankenButton.onclick = deleteTankenData;
      deleteLastTankenButton.onclick = deleteLastTanken;
      copyTankenButton.onclick = copyTanken;

      saveInspektionButton.onclick = saveInspektion;
      deleteInspektionButton.onclick = deleteInspektion;
      copyInspektionButton.onclick = copyInspektion;

      deleteAllButton.onclick = deleteAllData;

      // Laden
      loadVehicleData();
      loadOelIntervall();
      seedInitialWartung();
      renderWartungTable();
      loadTankDefaults();
      setTodayForTankDate();
      renderTankenTable();
      loadInspektion();
      renderDashboard();
    }

    window.addEventListener("load", init);
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Fahrzeugmanager</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      max-width: 1100px;
    }
    h1, h2, h3 {
      color: #333;
    }
    .box {
      border: 1px solid #ccc;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 6px;
      background: #f9f9f9;
    }
    label {
      display: block;
      margin-top: 8px;
      font-weight: bold;
    }
    input[type="text"],
    input[type="number"],
    input[type="date"],
    select,
    textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 6px;
      margin-top: 2px;
    }
    button {
      margin-top: 10px;
      padding: 8px 14px;
      cursor: pointer;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 0.9rem;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: left;
    }
    th {
      background: #eee;
    }
    .flex-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .flex-col {
      flex: 1 1 250px;
    }
    .danger {
      background: #fbe9e9;
      border-color: #f5b5b5;
    }
    .small-text {
      font-size: 0.8rem;
      color: #666;
    }
    .summary {
      margin-top: 10px;
      font-size: 0.9rem;
    }
    .highlight {
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Fahrzeugmanager</h1>
  <p class="small-text">
    Alles wird nur lokal im Browser gespeichert. Kein Internet, kein Server.<br>
    Passwort zum Löschen: <span class="highlight">Fatih</span>
  </p>

  <!-- Dashboard -->
  <div class="box">
    <h2>Übersicht (Dashboard)</h2>
    <p class="small-text">
      TÜV, letzter Ölwechsel und letzter Verbrauch im Überblick.
    </p>
    <ul>
      <li><strong>TÜV:</strong> <span id="dashTuevInfo">keine Daten</span></li>
      <li><strong>Letzter Ölwechsel:</strong> <span id="dashOilInfo">keine Einträge gefunden</span></li>
      <li><strong>Letzter Verbrauch:</strong> <span id="dashFuelInfo">keine Tankdaten</span></li>
    </ul>
  </div>

  <!-- Fahrzeugdaten -->
  <div class="box">
    <h2>Fahrzeugdaten</h2>
    <p class="small-text">
      Hier kannst du Marke, Modell, Schlüsselnummern und TÜV speichern.
    </p>
    <div class="flex-row">
      <div class="flex-col">
        <label for="markeInput">Marke</label>
        <input type="text" id="markeInput" placeholder="z. B. Mazda">

        <label for="modellInput">Modell</label>
        <input type="text" id="modellInput" placeholder="z. B. 2 DY">

        <label for="kontaktInput">Kontakt / Handy</label>
        <input type="text" id="kontaktInput" placeholder="z. B. 0176 ...">
      </div>
      <div class="flex-col">
        <label for="schluessel21Input">Schlüsselnummer zu 2.1</label>
        <input type="text" id="schluessel21Input" placeholder="z. B. 7118">

        <label for="schluessel22Input">Schlüsselnummer zu 2.2</label>
        <input type="text" id="schluessel22Input" placeholder="z. B. 273">

        <label for="kennzeichenInput">Kennzeichen / Notiz</label>
        <input type="text" id="kennzeichenInput" placeholder="z. B. V-AB 123">
      </div>
      <div class="flex-col">
        <label for="tuevBisInput">TÜV gültig bis</label>
        <input type="date" id="tuevBisInput">
        <p class="small-text">
          Wird im Dashboard angezeigt, wie lange der TÜV noch gilt.
        </p>
      </div>
    </div>
    <button id="saveVehicleButton">Fahrzeugdaten speichern</button>
    <button id="deleteVehicleButton">Fahrzeugdaten löschen (Passwort)</button>
    <p id="vehicleSavedMessage" class="small-text"></p>
  </div>

  <!-- Wartung / Reparaturen -->
  <div class="box">
    <h2>Wartung &amp; Reparaturen</h2>
    <p class="small-text">
      Trage hier z. B. Zahnriemenwechsel, Ölwechsel, TÜV, Bremsen usw. ein.
      Das Datum wird automatisch mit dem aktuellen Tag übernommen.<br>
      <strong>Hinweis:</strong> Für den letzten Ölwechsel im Dashboard wird der letzte Eintrag genommen,
      bei dem in der Beschreibung das Wort „Öl“ oder „Ölwechsel“ vorkommt.<br>
      Wenn du im Text „TÜV“ eingibst, wirst du gefragt, ob das TÜV-Datum oben aktualisiert werden soll.
    </p>

    <div class="flex-row">
      <div class="flex-col">
        <label for="wartungKmInput">Kilometerstand</label>
        <input type="number" id="wartungKmInput" min="0" step="1" placeholder="z. B. 145000">
      </div>
      <div class="flex-col">
        <label for="wartungArtInput">Reparatur / Wartung</label>
        <input type="text" id="wartungArtInput" placeholder="z. B. Ölwechsel, TÜV, Zahnriemenwechsel">
      </div>
    </div>

    <button id="addWartungButton">Wartung hinzufügen (heutiges Datum)</button>
    <button id="deleteLastWartungButton">Letzten Wartungs-Eintrag löschen (Passwort)</button>
    <button id="deleteWartungButton">Alle Wartungs-Einträge löschen (Passwort)</button>
    <button id="copyWartungButton">Wartungsdaten kopieren</button>

    <table>
      <thead>
        <tr>
          <th>Datum</th>
          <th>Kilometerstand</th>
          <th>Reparatur / Wartung</th>
        </tr>
      </thead>
      <tbody id="wartungTableBody">
        <!-- gefüllt aus localStorage -->
      </tbody>
    </table>
  </div>

  <!-- Tanken / Verbrauch -->
  <div class="box">
    <h2>Tanken &amp; Verbrauch</h2>
    <p class="small-text">
      Trage Tankvorgänge ein. Verbrauch und Kosten werden automatisch berechnet.<br>
      Verbrauch: Liter / gefahrene Kilometer × 100.
    </p>

    <div class="flex-row">
      <div class="flex-col">
        <label for="tankenDatumInput">Datum</label>
        <input type="date" id="tankenDatumInput">

        <label for="tankenKmInput">gefahrene Kilometer</label>
        <input type="number" id="tankenKmInput" min="0" step="1" placeholder="z. B. 450">
      </div>
      <div class="flex-col">
        <label for="tankenKraftstoffInput">Kraftstoffart</label>
        <select id="tankenKraftstoffInput">
          <option value="">bitte wählen</option>
          <option value="Benzin">Benzin</option>
          <option value="Diesel">Diesel</option>
          <option value="LPG">LPG / Gas</option>
          <option value="Hybrid/sonstiges">Hybrid / Sonstiges</option>
        </select>

        <label for="tankenLiterInput">getankte Liter</label>
        <input type="number" id="tankenLiterInput" min="0" step="0.01" placeholder="z. B. 32.5">
      </div>
      <div class="flex-col">
        <label for="tankenPreisInput">Preis pro Liter (€)</label>
        <input type="number" id="tankenPreisInput" min="0" step="0.001" placeholder="z. B. 1.849">
        <p class="small-text">
          Standardmäßig ist hier nichts vorgegeben – Preis immer selbst eintragen.
        </p>
      </div>
    </div>

    <button id="addTankenButton">Tanken-Eintrag hinzufügen</button>
    <button id="deleteLastTankenButton">Letzten Tank-Eintrag löschen (Passwort)</button>
    <button id="deleteTankenButton">Alle Tank-Einträge löschen (Passwort)</button>
    <button id="copyTankenButton">Tankdaten kopieren</button>

    <table>
      <thead>
        <tr>
          <th>Datum</th>
          <th>Kraftstoff</th>
          <th>km</th>
          <th>Liter</th>
          <th>Preis/Liter (€)</th>
          <th>Gesamtkosten (€)</th>
          <th>Verbrauch (L/100km)</th>
        </tr>
      </thead>
      <tbody id="tankenTableBody">
        <!-- gefüllt aus localStorage -->
      </tbody>
    </table>

    <div id="tankenSummary" class="summary"></div>
  </div>

  <!-- Inspektions-Notizen -->
  <div class="box">
    <h2>Inspektions-Notizen</h2>
    <p class="small-text">
      Hier kannst du deinen eigenen Plan notieren
      (z. B. „Ölwechsel alle 15.000 km“, „TÜV 06/2026“, „Zahnriemen alle 90.000 km“).
    </p>
    <label for="inspektionNotizen">Eigener Inspektionsplan / Notizen</label>
    <textarea id="inspektionNotizen" rows="5"></textarea>
    <button id="saveInspektionButton">Inspektions-Notizen speichern</button>
    <button id="copyInspektionButton">Inspektions-Notizen kopieren</button>
    <button id="deleteInspektionButton">Inspektions-Notizen löschen (Passwort)</button>
    <p id="inspektionSavedMessage" class="small-text"></p>
  </div>

  <!-- Alle Daten löschen -->
  <div class="box danger">
    <h2>ALLE Daten löschen</h2>
    <p class="small-text">
      Löscht Fahrzeugdaten, Wartungs- und Tankliste sowie Inspektions-Notizen.<br>
      Nur mit Passwort und zusätzlicher Sicherheitsfrage.
    </p>
    <button id="deleteAllButton">ALLE Daten löschen (Passwort)</button>
    <p id="deleteMessage" class="small-text"></p>
  </div>

  <script>
    // ==========================
    // Konfiguration
    // ==========================
    const PASSWORD = "Fatih";
    const VEHICLE_KEY = "fahrzeug_daten_v1";
    const WARTUNG_KEY = "fahrzeug_wartung_v1";
    const TANKEN_KEY = "fahrzeug_tanken_v1";
    const INSPEKTION_KEY = "fahrzeug_inspektion_v1";

    // ==========================
    // Hilfsfunktionen Passwort
    // ==========================
    function askPasswordThen(callback) {
      const eingabe = prompt("Bitte Passwort zum Löschen eingeben:");
      if (eingabe === null) return; // abgebrochen
      if (eingabe !== PASSWORD) {
        alert("Falsches Passwort.");
        return;
      }
      const sicher = confirm("Bist du sicher, dass du löschen möchtest?");
      if (!sicher) return;
      callback();
    }

    // ==========================
    // Fahrzeugdaten
    // ==========================
    function loadVehicleData() {
      const raw = localStorage.getItem(VEHICLE_KEY);
      let data;

      if (raw) {
        try {
          data = JSON.parse(raw);
        } catch {
          data = null;
        }
      }

      // Falls nichts gespeichert: Mazda 2DY mit Schlüsselnummern vorbelegen
      if (!data) {
        data = {
          marke: "Mazda",
          modell: "2 DY",
          kontakt: "",
          schluessel21: "7118",
          schluessel22: "273",
          kennzeichen: "",
          tuevBis: ""
        };
      } else {
        if (!("tuevBis" in data)) data.tuevBis = "";
      }

      document.getElementById("markeInput").value = data.marke || "";
      document.getElementById("modellInput").value = data.modell || "";
      document.getElementById("kontaktInput").value = data.kontakt || "";
      document.getElementById("schluessel21Input").value = data.schluessel21 || "";
      document.getElementById("schluessel22Input").value = data.schluessel22 || "";
      document.getElementById("kennzeichenInput").value = data.kennzeichen || "";
      document.getElementById("tuevBisInput").value = data.tuevBis || "";
    }

    function saveVehicleData() {
      const data = {
        marke: document.getElementById("markeInput").value.trim(),
        modell: document.getElementById("modellInput").value.trim(),
        kontakt: document.getElementById("kontaktInput").value.trim(),
        schluessel21: document.getElementById("schluessel21Input").value.trim(),
        schluessel22: document.getElementById("schluessel22Input").value.trim(),
        kennzeichen: document.getElementById("kennzeichenInput").value.trim(),
        tuevBis: document.getElementById("tuevBisInput").value
      };
      localStorage.setItem(VEHICLE_KEY, JSON.stringify(data));
      const msg = document.getElementById("vehicleSavedMessage");
      msg.textContent = "Fahrzeugdaten gespeichert.";
      setTimeout(() => { msg.textContent = ""; }, 3000);
      renderDashboard();
    }

    function autoUpdateTuevFromInput() {
      const raw = localStorage.getItem(VEHICLE_KEY);
      let data = null;
      if (raw) {
        try { data = JSON.parse(raw); } catch { data = null; }
      }
      if (!data) {
        data = {
          marke: document.getElementById("markeInput").value.trim() || "Mazda",
          modell: document.getElementById("modellInput").value.trim() || "2 DY",
          kontakt: document.getElementById("kontaktInput").value.trim() || "",
          schluessel21: document.getElementById("schluessel21Input").value.trim() || "7118",
          schluessel22: document.getElementById("schluessel22Input").value.trim() || "273",
          kennzeichen: document.getElementById("kennzeichenInput").value.trim() || "",
          tuevBis: document.getElementById("tuevBisInput").value
        };
      } else {
        data.tuevBis = document.getElementById("tuevBisInput").value;
      }
      localStorage.setItem(VEHICLE_KEY, JSON.stringify(data));
      renderDashboard();
    }

    function deleteVehicleData() {
      askPasswordThen(() => {
        localStorage.removeItem(VEHICLE_KEY);
        loadVehicleData();
        renderDashboard();
        const msg = document.getElementById("vehicleSavedMessage");
        msg.textContent = "Fahrzeugdaten gelöscht (Standard Mazda 2 DY wieder eingesetzt).";
        setTimeout(() => { msg.textContent = ""; }, 4000);
      });
    }

    // ==========================
    // Wartung / Reparaturen
    // ==========================
    function getWartungList() {
      const raw = localStorage.getItem(WARTUNG_KEY);
      if (!raw) return [];
      try {
        return JSON.parse(raw);
      } catch {
        return [];
      }
    }

    function saveWartungList(list) {
      localStorage.setItem(WARTUNG_KEY, JSON.stringify(list));
    }

    function renderWartungTable() {
      const tbody = document.getElementById("wartungTableBody");
      tbody.innerHTML = "";
      const list = getWartungList();

      list
        .slice()
        .sort((a, b) => (a.dateMs || 0) - (b.dateMs || 0))
        .forEach(entry => {
          const tr = document.createElement("tr");
          const tdDatum = document.createElement("td");
          const tdKm = document.createElement("td");
          const tdArt = document.createElement("td");

          tdDatum.textContent = entry.datum || "";
          tdKm.textContent = entry.km != null ? entry.km : "";
          tdArt.textContent = entry.art || "";

          tr.appendChild(tdDatum);
          tr.appendChild(tdKm);
          tr.appendChild(tdArt);
          tbody.appendChild(tr);
        });
    }

    function maybeAskUpdateTuevFromWartung(artText) {
      if (!artText) return;
      const t = artText.toLowerCase();
      if (!(t.includes("tüv") || t.includes("tuev") || t.includes("tuv"))) return;

      const willUpdate = confirm(
        "In diesem Wartungseintrag steht 'TÜV'.\n" +
        "Möchtest du das TÜV-Datum im Dashboard aktualisieren?"
      );
      if (!willUpdate) return;

      const current = document.getElementById("tuevBisInput").value || "";
      const input = prompt(
        "Bitte neues TÜV-Datum eingeben (Format JJJJ-MM-TT):",
        current
      );
      if (!input) return;

      const regex = /^\d{4}-\d{2}-\d{2}$/;
      if (!regex.test(input)) {
        alert("Ungültiges Format. Bitte JJJJ-MM-TT verwenden (z. B. 2026-06-30).");
        return;
      }

      document.getElementById("tuevBisInput").value = input;
      autoUpdateTuevFromInput();
    }

    function addWartungEntry() {
      const kmValue = document.getElementById("wartungKmInput").value;
      const artValue = document.getElementById("wartungArtInput").value.trim();

      const km = kmValue === "" ? null : Number(kmValue);
      if (km == null || isNaN(km)) {
        alert("Bitte einen gültigen Kilometerstand eingeben.");
        return;
      }
      if (!artValue) {
        alert("Bitte eine Beschreibung der Wartung/Reparatur eingeben.");
        return;
      }

      const now = new Date();
      const datumText = now.toLocaleDateString("de-DE");
      const dateMs = now.getTime();

      const list = getWartungList();
      list.push({
        datum: datumText,
        dateMs: dateMs,
        km: km,
        art: artValue
      });
      saveWartungList(list);
      document.getElementById("wartungKmInput").value = "";
      document.getElementById("wartungArtInput").value = "";
      renderWartungTable();
      renderDashboard();

      // Falls im Text "TÜV" steht, optional TÜV-Datum im Dashboard aktualisieren
      maybeAskUpdateTuevFromWartung(artValue);
    }

    function deleteWartungData() {
      askPasswordThen(() => {
        localStorage.removeItem(WARTUNG_KEY);
        renderWartungTable();
        renderDashboard();
      });
    }

    function deleteLastWartung() {
      askPasswordThen(() => {
        const list = getWartungList();
        if (list.length === 0) {
          alert("Keine Wartungseinträge vorhanden.");
          return;
        }
        list.pop();
        saveWartungList(list);
        renderWartungTable();
        renderDashboard();
      });
    }

    // ==========================
    // Tanken / Verbrauch
    // ==========================
    function getTankenList() {
      const raw = localStorage.getItem(TANKEN_KEY);
      if (!raw) return [];
      try {
        return JSON.parse(raw);
      } catch {
        return [];
      }
    }

    function saveTankenList(list) {
      localStorage.setItem(TANKEN_KEY, JSON.stringify(list));
    }

    function renderTankenTable() {
      const tbody = document.getElementById("tankenTableBody");
      tbody.innerHTML = "";
      const list = getTankenList();

      list
        .slice()
        .sort((a, b) => (a.dateMs || 0) - (b.dateMs || 0))
        .forEach(entry => {
          const tr = document.createElement("tr");
          const tdDatum = document.createElement("td");
          const tdKraftstoff = document.createElement("td");
          const tdKm = document.createElement("td");
          const tdLiter = document.createElement("td");
          const tdPreis = document.createElement("td");
          const tdKosten = document.createElement("td");
          const tdVerbrauch = document.createElement("td");

          tdDatum.textContent = entry.datum || "";
          tdKraftstoff.textContent = entry.kraftstoff || "";
          tdKm.textContent = entry.km != null ? entry.km : "";
          tdLiter.textContent = entry.liter != null ? entry.liter.toFixed(2) : "";
          tdPreis.textContent = entry.preis != null ? entry.preis.toFixed(3) : "";
          tdKosten.textContent = entry.kosten != null ? entry.kosten.toFixed(2) : "";
          tdVerbrauch.textContent = entry.verbrauch != null ? entry.verbrauch.toFixed(2) : "";

          tr.appendChild(tdDatum);
          tr.appendChild(tdKraftstoff);
          tr.appendChild(tdKm);
          tr.appendChild(tdLiter);
          tr.appendChild(tdPreis);
          tr.appendChild(tdKosten);
          tr.appendChild(tdVerbrauch);
          tbody.appendChild(tr);
        });

      renderTankenSummary();
    }

    function renderTankenSummary() {
      const list = getTankenList();
      const summary = document.getElementById("tankenSummary");
      if (list.length === 0) {
        summary.textContent = "Noch keine Tankdaten erfasst.";
        renderDashboard();
        return;
      }

      let sumVerbrauch = 0;
      let zaehler = 0;
      let sumKosten = 0;

      list.forEach(e => {
        if (e.verbrauch != null && !isNaN(e.verbrauch) && e.km > 0) {
          sumVerbrauch += e.verbrauch;
          zaehler++;
        }
        if (e.kosten != null && !isNaN(e.kosten)) {
          sumKosten += e.kosten;
        }
      });

      const avgVerbrauch = zaehler > 0 ? (sumVerbrauch / zaehler) : null;

      const last = list.slice().sort((a, b) => (a.dateMs || 0) - (b.dateMs || 0)).pop();

      let text = `Anzahl Tankvorgänge: ${list.length}. Gesamt-Kosten: ${sumKosten.toFixed(2)} €.`;
      if (avgVerbrauch != null) {
        text += ` Durchschnittsverbrauch: ${avgVerbrauch.toFixed(2)} L/100km.`;
      }
      if (last && last.verbrauch != null && !isNaN(last.verbrauch)) {
        text += ` Letzter Verbrauch: ${last.verbrauch.toFixed(2)} L/100km.`;
      }

      summary.textContent = text;
      renderDashboard();
    }

    function addTankenEntry() {
      const datumValue = document.getElementById("tankenDatumInput").value;
      const kmValue = document.getElementById("tankenKmInput").value;
      const kraftstoffValue = document.getElementById("tankenKraftstoffInput").value;
      const literValue = document.getElementById("tankenLiterInput").value;
      const preisValue = document.getElementById("tankenPreisInput").value;

      const km = kmValue === "" ? null : Number(kmValue);
      const liter = literValue === "" ? null : Number(literValue);
      const preis = preisValue === "" ? null : Number(preisValue);

      if (km == null || isNaN(km) || km <= 0) {
        alert("Bitte gültige gefahrene Kilometer eingeben (> 0).");
        return;
      }
      if (liter == null || isNaN(liter) || liter <= 0) {
        alert("Bitte gültige Literzahl eingeben (> 0).");
        return;
      }
      if (preis == null || isNaN(preis) || preis <= 0) {
        alert("Bitte gültigen Preis pro Liter eingeben (> 0).");
        return;
      }
      if (!kraftstoffValue) {
        alert("Bitte eine Kraftstoffart auswählen.");
        return;
      }

      let dateObj;
      if (datumValue) {
        const parts = datumValue.split("-");
        if (parts.length === 3) {
          const year = Number(parts[0]);
          const month = Number(parts[1]) - 1;
          const day = Number(parts[2]);
          dateObj = new Date(year, month, day);
        } else {
          dateObj = new Date();
        }
      } else {
        dateObj = new Date();
      }

      const datumText = dateObj.toLocaleDateString("de-DE");
      const dateMs = dateObj.getTime();

      const kosten = liter * preis;
      const verbrauch = (liter / km) * 100;

      const list = getTankenList();
      list.push({
        datum: datumText,
        dateMs: dateMs,
        km: km,
        kraftstoff: kraftstoffValue,
        liter: liter,
        preis: preis,
        kosten: kosten,
        verbrauch: verbrauch
      });
      saveTankenList(list);

      document.getElementById("tankenKmInput").value = "";
      document.getElementById("tankenLiterInput").value = "";
      document.getElementById("tankenPreisInput").value = "";

      renderTankenTable();
    }

    function deleteTankenData() {
      askPasswordThen(() => {
        localStorage.removeItem(TANKEN_KEY);
        renderTankenTable();
        renderDashboard();
      });
    }

    function deleteLastTanken() {
      askPasswordThen(() => {
        const list = getTankenList();
        if (list.length === 0) {
          alert("Keine Tank-Einträge vorhanden.");
          return;
        }
        list.pop();
        saveTankenList(list);
        renderTankenTable();
        renderDashboard();
      });
    }

    // ==========================
    // Kopier-Funktionen
    // ==========================
    function copyTextToClipboard(text) {
      if (!text) {
        alert("Nichts zum Kopieren vorhanden.");
        return;
      }

      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text)
          .then(() => alert("Text in Zwischenablage kopiert."))
          .catch(() => fallbackCopy(text));
      } else {
        fallbackCopy(text);
      }
    }

    function fallbackCopy(text) {
      const temp = document.createElement("textarea");
      temp.value = text;
      document.body.appendChild(temp);
      temp.select();
      try { document.execCommand("copy"); } catch (e) {}
      document.body.removeChild(temp);
      alert("Text in Zwischenablage kopiert.");
    }

    function copyInspektion() {
      const text = document.getElementById("inspektionNotizen").value.trim();
      if (!text) {
        alert("Keine Inspektions-Notizen vorhanden.");
        return;
      }
      copyTextToClipboard(text);
    }

    function copyTanken() {
      const list = getTankenList();
      if (list.length === 0) {
        alert("Keine Tank-Einträge vorhanden.");
        return;
      }

      let lines = [];
      lines.push("Datum;Kraftstoff;km;Liter;Preis/Liter;Gesamtkosten;Verbrauch L/100km");

      list
        .slice()
        .sort((a, b) => (a.dateMs || 0) - (b.dateMs || 0))
        .forEach(e => {
          const line = [
            e.datum || "",
            e.kraftstoff || "",
            e.km != null ? e.km : "",
            e.liter != null ? e.liter.toFixed(2) : "",
            e.preis != null ? e.preis.toFixed(3) : "",
            e.kosten != null ? e.kosten.toFixed(2) : "",
            e.verbrauch != null ? e.verbrauch.toFixed(2) : ""
          ].join(";");
          lines.push(line);
        });

      const summary = document.getElementById("tankenSummary").textContent || "";
      if (summary) {
        lines.push("");
        lines.push("Zusammenfassung:");
        lines.push(summary);
      }

      copyTextToClipboard(lines.join("\n"));
    }

    function copyWartung() {
      const list = getWartungList();
      if (list.length === 0) {
        alert("Keine Wartungsdaten vorhanden.");
        return;
      }

      let lines = [];
      lines.push("Datum;Kilometer;Text");

      list
        .slice()
        .sort((a, b) => (a.dateMs || 0) - (b.dateMs || 0))
        .forEach(e => {
          const line = [
            e.datum || "",
            e.km != null ? e.km : "",
            e.art || ""
          ].join(";");
          lines.push(line);
        });

      copyTextToClipboard(lines.join("\n"));
    }

    // ==========================
    // Inspektions-Notizen
    // ==========================
    function loadInspektion() {
      const raw = localStorage.getItem(INSPEKTION_KEY);
      if (raw) {
        document.getElementById("inspektionNotizen").value = raw;
      } else {
        document.getElementById("inspektionNotizen").value = "";
      }
    }

    function saveInspektion() {
      const text = document.getElementById("inspektionNotizen").value;
      localStorage.setItem(INSPEKTION_KEY, text);
      const msg = document.getElementById("inspektionSavedMessage");
      msg.textContent = "Inspektions-Notizen gespeichert.";
      setTimeout(() => { msg.textContent = ""; }, 3000);
    }

    function deleteInspektion() {
      askPasswordThen(() => {
        localStorage.removeItem(INSPEKTION_KEY);
        loadInspektion();
      });
    }

    // ==========================
    // Dashboard
    // ==========================
    function renderDashboard() {
      const tuevSpan = document.getElementById("dashTuevInfo");
      const oilSpan = document.getElementById("dashOilInfo");
      const fuelSpan = document.getElementById("dashFuelInfo");

      // TÜV
      const rawVehicle = localStorage.getItem(VEHICLE_KEY);
      let tuevText = "keine Daten";
      if (rawVehicle) {
        try {
          const v = JSON.parse(rawVehicle);
          if (v.tuevBis) {
            const parts = v.tuevBis.split("-");
            if (parts.length === 3) {
              const year = Number(parts[0]);
              const month = Number(parts[1]) - 1;
              const day = Number(parts[2]);
              const tuevDate = new Date(year, month, day);
              const heute = new Date();
              tuevDate.setHours(0,0,0,0);
              heute.setHours(0,0,0,0);
              const diffMs = tuevDate.getTime() - heute.getTime();
              const diffTage = Math.round(diffMs / (1000 * 60 * 60 * 24));
              const datumText = tuevDate.toLocaleDateString("de-DE");

              if (diffTage > 0) {
                tuevText = `bis ${datumText} (noch ca. ${diffTage} Tage)`;
              } else if (diffTage === 0) {
                tuevText = `bis ${datumText} (läuft HEUTE ab!)`;
              } else {
                tuevText = `abgelaufen am ${datumText} (seit ${Math.abs(diffTage)} Tagen)`;
              }
            }
          }
        } catch {}
      }
      tuevSpan.textContent = tuevText;

      // Letzter Ölwechsel
      const wartungen = getWartungList();
      const oilEntries = wartungen.filter(e => {
        if (!e.art) return false;
        const t = e.art.toLowerCase();
        return t.includes("öl") || t.includes("oel");
      });
      if (oilEntries.length === 0) {
        oilSpan.textContent = "keine Ölwechsel-Einträge gefunden.";
      } else {
        const lastOil = oilEntries.slice().sort((a, b) => (a.dateMs || 0) - (b.dateMs || 0)).pop();
        let txt = `am ${lastOil.datum}`;
        if (lastOil.km != null) {
          txt += ` bei ca. ${lastOil.km} km`;
        }
        oilSpan.textContent = txt;
      }

      // Letzter Verbrauch
      const tanken = getTankenList();
      if (tanken.length === 0) {
        fuelSpan.textContent = "keine Tankdaten vorhanden.";
      } else {
        const last = tanken.slice().sort((a, b) => (a.dateMs || 0) - (b.dateMs || 0)).pop();
        if (last.verbrauch != null && !isNaN(last.verbrauch)) {
          fuelSpan.textContent =
            `${last.verbrauch.toFixed(2)} L/100km (${last.datum}, ${last.kraftstoff || "Kraftstoff unbekannt"})`;
        } else {
          fuelSpan.textContent = "kein Verbrauch berechnet.";
        }
      }
    }

    // ==========================
    // Alle Daten löschen
    // ==========================
    function deleteAllData() {
      askPasswordThen(() => {
        localStorage.removeItem(VEHICLE_KEY);
        localStorage.removeItem(WARTUNG_KEY);
        localStorage.removeItem(TANKEN_KEY);
        localStorage.removeItem(INSPEKTION_KEY);

        loadVehicleData();
        renderWartungTable();
        renderTankenTable();
        loadInspektion();
        renderDashboard();

        const msg = document.getElementById("deleteMessage");
        msg.textContent = "Alle Daten wurden gelöscht.";
        setTimeout(() => { msg.textContent = ""; }, 4000);
      });
    }

    // ==========================
    // Event-Handler / init
    // ==========================
    document.getElementById("saveVehicleButton").addEventListener("click", saveVehicleData);
    document.getElementById("deleteVehicleButton").addEventListener("click", deleteVehicleData);
    document.getElementById("tuevBisInput").addEventListener("change", autoUpdateTuevFromInput);

    document.getElementById("addWartungButton").addEventListener("click", addWartungEntry);
    document.getElementById("deleteWartungButton").addEventListener("click", deleteWartungData);
    document.getElementById("deleteLastWartungButton").addEventListener("click", deleteLastWartung);
    document.getElementById("copyWartungButton").addEventListener("click", copyWartung);

    document.getElementById("addTankenButton").addEventListener("click", addTankenEntry);
    document.getElementById("deleteTankenButton").addEventListener("click", deleteTankenData);
    document.getElementById("deleteLastTankenButton").addEventListener("click", deleteLastTanken);
    document.getElementById("copyTankenButton").addEventListener("click", copyTanken);

    document.getElementById("saveInspektionButton").addEventListener("click", saveInspektion);
    document.getElementById("deleteInspektionButton").addEventListener("click", deleteInspektion);
    document.getElementById("copyInspektionButton").addEventListener("click", copyInspektion);

    document.getElementById("deleteAllButton").addEventListener("click", deleteAllData);

    // Beim Laden der Seite alles aus localStorage einlesen
    loadVehicleData();
    renderWartungTable();
    renderTankenTable();
    loadInspektion();
    renderDashboard();
  </script>
</body>
</html>